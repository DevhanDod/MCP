<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP - Menstrual Cycle Prediction</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <link rel="stylesheet" href="static/css/style.css">
    <style>
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: #DC2626;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .loading-subtext {
            font-size: 13px;
            color: #9ca3af;
        }

        /* Page visibility */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Loading AI Model...</div>
        <div class="loading-subtext" id="loading-status">Initializing Python runtime</div>
    </div>

    <!-- Page 1: Input Form -->
    <div class="container page active" id="page-form">
        <div class="card">
            <!-- Header -->
            <div class="header">
                <div class="logo-section">
                    <div class="logo">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2L2 7L12 12L22 7L12 2Z" fill="#DC2626" />
                            <path d="M2 17L12 22L22 17V7L12 12L2 7V17Z" fill="#DC2626" />
                        </svg>
                    </div>
                    <div class="title-section">
                        <h1>MCP</h1>
                        <p class="subtitle">Menstrual Cycle Prediction</p>
                    </div>
                </div>
                <button class="logout-btn" id="status-btn" title="Model loading...">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path
                            d="M6 14H3.33333C2.97971 14 2.64057 13.8595 2.39052 13.6095C2.14048 13.3594 2 13.0203 2 12.6667V3.33333C2 2.97971 2.14048 2.64057 2.39052 2.39052C2.64057 2.14048 2.97971 2 3.33333 2H6"
                            stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M10.6667 11.3333L14 8L10.6667 4.66667" stroke="white" stroke-width="1.5"
                            stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M14 8H6" stroke="white" stroke-width="1.5" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                </button>
            </div>

            <!-- Form Title -->
            <div class="form-header">
                <h2>Enter Your Information</h2>
                <p class="form-subtitle">Fill in the details below to predict your next cycle</p>
            </div>

            <!-- Error Message -->
            <div id="error" class="error-message" style="display: none;"></div>

            <!-- Form -->
            <form id="predictionForm">
                <div class="form-grid">
                    <!-- Left Column -->
                    <div class="form-group">
                        <label for="age">Age <span class="required">*</span></label>
                        <input type="number" id="age" name="age" placeholder="25" required min="10" max="60">
                    </div>

                    <div class="form-group">
                        <label for="weight">Weight (kg) <span class="required">*</span></label>
                        <input type="number" id="weight" name="weight" placeholder="55" required step="0.1">
                    </div>

                    <div class="form-group">
                        <label for="height">Height (m) <span class="required">*</span></label>
                        <input type="number" id="height" name="height" placeholder="1.65" required step="0.01">
                    </div>

                    <div class="form-group">
                        <label for="stress_level">Stress Level</label>
                        <select id="stress_level" name="stress_level" required>
                            <option value="1">1 - Very Low</option>
                            <option value="2">2 - Low</option>
                            <option value="3">3 - Moderate</option>
                            <option value="4">4 - Moderate-High</option>
                            <option value="5" selected>5 - Medium</option>
                            <option value="6">6 - Medium-High</option>
                            <option value="7">7 - High</option>
                            <option value="8">8 - Very High</option>
                            <option value="9">9 - Extreme</option>
                            <option value="10">10 - Maximum</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="period_length">Period Length</label>
                        <select id="period_length" name="period_length" required>
                            <option value="3">3 days</option>
                            <option value="4">4 days</option>
                            <option value="5" selected>5 days</option>
                            <option value="6">6 days</option>
                            <option value="7">7 days</option>
                        </select>
                    </div>

                    <!-- Right Column -->
                    <div class="form-group">
                        <label for="cycle_length">Cycle Length</label>
                        <select id="cycle_length" name="cycle_length" required>
                            <option value="21">21 days</option>
                            <option value="24">24 days</option>
                            <option value="26">26 days</option>
                            <option value="28" selected>28 days</option>
                            <option value="30">30 days</option>
                            <option value="32">32 days</option>
                            <option value="35">35 days</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="exercise_frequency">Exercise Frequency</label>
                        <select id="exercise_frequency" name="exercise_frequency" required>
                            <option value="none">None</option>
                            <option value="weekly">Weekly</option>
                            <option value="daily" selected>Daily</option>
                            <option value="occasionally">Occasionally</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="symptoms">Symptoms</label>
                        <select id="symptoms" name="symptoms" required>
                            <option value="none" selected>None</option>
                            <option value="headache">Headache</option>
                            <option value="cramps">Cramps</option>
                            <option value="bloating">Bloating</option>
                            <option value="fatigue">Fatigue</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="diet">Diet</label>
                        <select id="diet" name="diet" required>
                            <option value="balanced" selected>Balanced</option>
                            <option value="vegan">Vegan</option>
                            <option value="keto">Keto</option>
                            <option value="irregular">Irregular</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="sleep_hours">Sleep Hours</label>
                        <input type="number" id="sleep_hours" name="sleep_hours" placeholder="7" value="7" required
                            step="0.5" min="0" max="24">
                    </div>

                    <div class="form-group" style="grid-column: span 2;">
                        <label for="cycle_start_date">Cycle Start Date <span class="required">*</span></label>
                        <input type="date" id="cycle_start_date" name="cycle_start_date" required>
                    </div>
                </div>

                <button type="submit" class="submit-btn" id="submit-btn" disabled>Loading AI Model...</button>
            </form>

            <!-- Footer -->
            <div class="footer">
                <p>Devhan (20221394 - w1956126)</p>
            </div>
        </div>
    </div>

    <!-- Page 2: Results -->
    <div class="container page" id="page-results">
        <div class="card">
            <!-- Header -->
            <div class="header">
                <div class="logo-section">
                    <div class="logo">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2L2 7L12 12L22 7L12 2Z" fill="#DC2626" />
                            <path d="M2 17L12 22L22 17V7L12 12L2 7V17Z" fill="#DC2626" />
                        </svg>
                    </div>
                    <div class="title-section">
                        <h1>MCP</h1>
                        <p class="subtitle">Menstrual Cycle Prediction</p>
                    </div>
                </div>
                <button class="logout-btn" onclick="goBack()">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M10 2L14 8L10 14" stroke="white" stroke-width="1.5" stroke-linecap="round"
                            stroke-linejoin="round" transform="rotate(180 8 8)" />
                        <path d="M2 8H14" stroke="white" stroke-width="1.5" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                </button>
            </div>

            <!-- Form Title -->
            <div class="form-header">
                <h2>Prediction Results</h2>
                <p class="form-subtitle">Based on your input data and our AI model</p>
            </div>

            <!-- Results Display -->
            <div class="results-container">
                <div class="result-item">
                    <label>Your BMI:</label>
                    <div class="result-value" id="bmi-value">--</div>
                </div>

                <div class="result-item">
                    <label>Your Next Cycle:</label>
                    <div class="result-value" id="next-cycle">--</div>
                </div>

                <div class="result-item">
                    <label>Model Accuracy:</label>
                    <div class="result-value" id="accuracy">--</div>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer">
                <p>Devhan (20221394 - w1956126)</p>
            </div>
        </div>
    </div>

    <script>
        let pyodide = null;
        let modelReady = false;

        // Set max date to today
        document.getElementById('cycle_start_date').max = new Date().toISOString().split('T')[0];

        // Page navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        function goBack() {
            showPage('page-form');
        }

        // Initialize Pyodide
        async function initPyodide() {
            const loadingStatus = document.getElementById('loading-status');

            try {
                loadingStatus.textContent = 'Loading Python runtime...';
                pyodide = await loadPyodide();

                loadingStatus.textContent = 'Installing numpy...';
                await pyodide.loadPackage('numpy');

                loadingStatus.textContent = 'Installing pandas...';
                await pyodide.loadPackage('pandas');

                loadingStatus.textContent = 'Installing scikit-learn...';
                await pyodide.loadPackage('scikit-learn');

                loadingStatus.textContent = 'Training ML model...';

                await pyodide.runPythonAsync(`
import numpy as np
import pandas as pd
from sklearn.neural_network import MLPRegressor
from sklearn.preprocessing import OneHotEncoder, StandardScaler
from sklearn.compose import ColumnTransformer
from sklearn.pipeline import Pipeline
from sklearn.model_selection import train_test_split

np.random.seed(42)
n_samples = 500

data = {
    'Age': np.random.randint(18, 45, n_samples),
    'BMI': np.round(np.random.uniform(18, 35, n_samples), 1),
    'Stress Level': np.random.randint(1, 11, n_samples),
    'Sleep Hours': np.round(np.random.uniform(4, 10, n_samples), 1),
    'Cycle Length': np.random.choice([21, 24, 26, 28, 30, 32, 35], n_samples, 
                                     p=[0.05, 0.1, 0.15, 0.4, 0.15, 0.1, 0.05]),
    'Period Length': np.random.choice([3, 4, 5, 6, 7], n_samples,
                                      p=[0.1, 0.25, 0.35, 0.2, 0.1]),
    'Exercise Frequency': np.random.choice(['none', 'weekly', 'daily', 'occasionally'], n_samples,
                                           p=[0.2, 0.3, 0.25, 0.25]),
    'Diet': np.random.choice(['balanced', 'vegan', 'keto', 'irregular'], n_samples,
                             p=[0.4, 0.2, 0.15, 0.25]),
    'Symptoms': np.random.choice(['none', 'cramps', 'headache', 'bloating', 'fatigue'], n_samples,
                                 p=[0.3, 0.25, 0.15, 0.15, 0.15])
}

base_days = data['Cycle Length'] - data['Period Length']
variation = (data['Stress Level'] - 5) * 0.5 + (7 - data['Sleep Hours']) * 0.3
noise = np.random.normal(0, 1, n_samples)
data['days_until_next_period'] = np.maximum(1, base_days + variation + noise).astype(int)

df = pd.DataFrame(data)

num_cols = ['Age', 'BMI', 'Stress Level', 'Sleep Hours', 'Cycle Length', 'Period Length']
cat_cols = ['Exercise Frequency', 'Diet', 'Symptoms']

X = df[num_cols + cat_cols]
y = df['days_until_next_period']

X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

preprocessor = ColumnTransformer(
    transformers=[
        ('num', StandardScaler(), num_cols),
        ('cat', OneHotEncoder(handle_unknown='ignore'), cat_cols)
    ]
)

model = Pipeline([
    ('preprocessor', preprocessor),
    ('regressor', MLPRegressor(
        hidden_layer_sizes=(32, 16),
        activation='relu',
        max_iter=500,
        random_state=42,
        early_stopping=True,
        validation_fraction=0.2
    ))
])

model.fit(X_train, y_train)

y_pred = model.predict(X_test)
mae = np.mean(np.abs(y_test - y_pred))
model_accuracy = max(0, 100 - (mae / np.mean(y_test) * 100))

def predict(age, bmi, stress, sleep, cycle_len, period_len, exercise, diet, symptoms):
    X_one = pd.DataFrame([{
        'Age': age,
        'BMI': bmi,
        'Stress Level': stress,
        'Sleep Hours': sleep,
        'Cycle Length': cycle_len,
        'Period Length': period_len,
        'Exercise Frequency': exercise.lower(),
        'Diet': diet.lower(),
        'Symptoms': symptoms.lower()
    }])
    pred = float(model.predict(X_one)[0])
    return max(1, pred)
                `);

                modelReady = true;
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('submit-btn').disabled = false;
                document.getElementById('submit-btn').textContent = 'Predict Next Cycle';
                document.getElementById('status-btn').title = 'Model ready!';
                document.getElementById('status-btn').style.background = '#059669';

            } catch (error) {
                document.getElementById('loading-status').textContent = 'Error: ' + error.message;
                console.error(error);
            }
        }

        initPyodide();

        // Form submission
        document.getElementById('predictionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!modelReady) {
                alert('Please wait for the model to load');
                return;
            }

            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.textContent = 'Processing...';
            document.getElementById('error').style.display = 'none';

            try {
                const weight = parseFloat(document.getElementById('weight').value);
                const height = parseFloat(document.getElementById('height').value);
                const bmi = (weight / (height * height)).toFixed(2);

                const age = parseInt(document.getElementById('age').value);
                const stress = parseInt(document.getElementById('stress_level').value);
                const sleep = parseFloat(document.getElementById('sleep_hours').value);
                const cycleLen = parseInt(document.getElementById('cycle_length').value);
                const periodLen = parseInt(document.getElementById('period_length').value);
                const exercise = document.getElementById('exercise_frequency').value;
                const diet = document.getElementById('diet').value;
                const symptoms = document.getElementById('symptoms').value;

                const predDays = await pyodide.runPythonAsync(`
predict(${age}, ${bmi}, ${stress}, ${sleep}, ${cycleLen}, ${periodLen}, "${exercise}", "${diet}", "${symptoms}")
                `);

                const accuracy = await pyodide.runPythonAsync(`model_accuracy`);

                const startDate = new Date(document.getElementById('cycle_start_date').value);
                const nextDate = new Date(startDate);
                nextDate.setDate(nextDate.getDate() + Math.round(predDays));

                // Update results page
                document.getElementById('bmi-value').textContent = bmi;
                document.getElementById('next-cycle').textContent = nextDate.toLocaleDateString('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
                document.getElementById('accuracy').textContent = accuracy.toFixed(1) + '%';

                // Navigate to results page
                showPage('page-results');

            } catch (error) {
                document.getElementById('error').textContent = 'Error: ' + error.message;
                document.getElementById('error').style.display = 'block';
                console.error(error);
            }

            btn.disabled = false;
            btn.textContent = 'Predict Next Cycle';
        });
    </script>
</body>

</html>